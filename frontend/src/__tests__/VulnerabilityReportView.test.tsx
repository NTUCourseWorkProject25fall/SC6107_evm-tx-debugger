import React from 'react';
import { render, screen } from '@testing-library/react';
import VulnerabilityReportView from '@/components/VulnerabilityReportView';
import type { VulnerabilityReport } from '@/types/analysis';

const reportWithIssues: VulnerabilityReport = {
  vulnerabilities: [
    {
      id: 'REENTRANCY',
      name: 'Potential Reentrancy',
      severity: 'HIGH',
      description: 'External call followed by state change',
      recommendation: 'Apply checks-effects-interactions',
      affectedContracts: ['0xabcdefabcdefabcdefabcdefabcdefabcdefabcd'],
      affectedFunctions: ['0x12345678'],
      occurrenceCount: 1,
    },
    {
      id: 'LOW',
      name: 'Missing event',
      severity: 'LOW',
      description: 'State change without event',
      recommendation: 'Emit events',
      affectedContracts: [],
      affectedFunctions: [],
      occurrenceCount: 2,
    },
  ],
  totalIssues: 3,
  criticalCount: 0,
  highCount: 1,
  mediumCount: 0,
  lowCount: 2,
};

const reportNoIssues: VulnerabilityReport = {
  vulnerabilities: [],
  totalIssues: 0,
  criticalCount: 0,
  highCount: 0,
  mediumCount: 0,
  lowCount: 0,
};

describe('VulnerabilityReportView', () => {
  it('renders Vulnerability Report heading', () => {
    render(<VulnerabilityReportView report={reportWithIssues} />);
    expect(screen.getByText(/Vulnerability Report/i)).toBeInTheDocument();
  });

  it('shows no vulnerabilities message when totalIssues is 0', () => {
    render(<VulnerabilityReportView report={reportNoIssues} />);
    expect(screen.getByText(/No Vulnerabilities Detected/i)).toBeInTheDocument();
    expect(screen.getByText(/did not identify any security issues/i)).toBeInTheDocument();
  });

  it('shows severity counts when issues exist', () => {
    render(<VulnerabilityReportView report={reportWithIssues} />);
    expect(screen.getByText(/Critical/)).toBeInTheDocument();
    expect(screen.getByText(/High/)).toBeInTheDocument();
    expect(screen.getByText(/Low/)).toBeInTheDocument();
    expect(screen.getByText(/Total/)).toBeInTheDocument();
    expect(screen.getByText(/Potential Reentrancy/)).toBeInTheDocument();
  });

  it('renders vulnerability name and severity', () => {
    render(<VulnerabilityReportView report={reportWithIssues} />);
    expect(screen.getByText(/Potential Reentrancy/)).toBeInTheDocument();
    expect(screen.getByText('HIGH')).toBeInTheDocument();
    expect(screen.getByText(/External call followed by state change/)).toBeInTheDocument();
    expect(screen.getByText(/Apply checks-effects-interactions/)).toBeInTheDocument();
  });

  it('shows occurrence count', () => {
    render(<VulnerabilityReportView report={reportWithIssues} />);
    expect(screen.getByText(/\(1 occurrence\)/)).toBeInTheDocument();
    expect(screen.getByText(/\(2 occurrences\)/)).toBeInTheDocument();
  });

  it('shows affected contracts when present', () => {
    render(<VulnerabilityReportView report={reportWithIssues} />);
    expect(screen.getByText(/Affected Contracts:/)).toBeInTheDocument();
  });
});
